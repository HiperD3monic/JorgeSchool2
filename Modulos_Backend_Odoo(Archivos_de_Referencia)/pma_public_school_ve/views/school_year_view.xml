<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- model.name kanban view -->
    <record id="school_year_view_kanban" model="ir.ui.view">
        <field name="name">school.year.view.kanban</field>
        <field name="model">school.year</field>
        <field name="arch" type="xml">
            <kanban>
                <templates>
                    <t t-name="card">
                            <main class="o_project_kanban_main">
                                <div class="d-flex align-items-baseline gap-1">
                                    <span class="text-truncate d-block fs-4 fw-bold" t-att-title="record.display_name.value"><field name="display_name"/></span>
                                </div>
                                <!-- <div class="o_project_kanban_body min-w-0 pb-4 me-2">
                                    <span name="partner_name" class="text-muted d-flex align-items-baseline" t-if="record.partner_id.value">
                                        <span class="fa fa-user me-2" aria-label="Partner" title="Partner"/><field class="text-truncate" name="partner_id"/>
                                    </span>
                                    <div t-if="record.date.raw_value or record.date_start.raw_value" class="text-muted d-flex align-items-baseline">
                                        <span class="fa fa-clock-o me-2" title="Dates"/>
                                        <field name="date_start" widget="daterange" options="{'end_date_field': 'date'}"/>
                                    </div>
                                    <div t-if="record.alias_email.value" class="text-muted text-truncate" t-att-title="record.alias_email.value">
                                        <span class="fa fa-envelope-o me-2" aria-label="Domain Alias" title="Domain Alias"/><field name="alias_email"/>
                                    </div>
                                    <div t-if="record.rating_count.raw_value &gt; 0" class="d-flex text-muted">
                                        <b class="me-1">
                                            <span class="fa mt4 fa-smile-o fw-bolder text-success" t-if="record.rating_avg.raw_value &gt;= 3.66" title="Average Rating: Happy" role="img" aria-label="Happy face"/>
                                            <span class="fa mt4 fa-meh-o fw-bolder text-warning" t-elif="record.rating_avg.raw_value &gt;= 2.33" title="Average Rating: Neutral" role="img" aria-label="Neutral face"/>
                                            <span class="fa mt4 fa-frown-o fw-bolder text-danger" t-else="" title="Average Rating: Unhappy" role="img" aria-label="Unhappy face"/>
                                        </b>
                                        <t t-if="record.rating_avg.raw_value % 1 == 0">
                                            <field name="rating_avg" nolabel="1" widget="float" digits="[1, 0]"/>
                                        </t>
                                        <t t-else="">
                                            <field name="rating_avg" nolabel="1" widget="float" digits="[1, 1]"/>
                                        </t> / 5
                                    </div>
                                    <field name="tag_ids" widget="many2many_tags" options="{'color_field': 'color'}"/>
                                </div> -->
                            </main>
                            <footer class="mt-auto pt-0">
                                <!-- <div class="d-flex align-items-center">
                                    <div class="o_project_kanban_boxes d-flex align-items-baseline">
                                        <a class="o_project_kanban_box me-1" name="action_view_tasks" type="object">
                                            <div>
                                                <field name="open_task_count" class="o_value"/>
                                                <field name="label_tasks" class="ms-1"/>
                                            </div>
                                        </a>
                                        <a groups="project.group_project_milestone" t-if="record.allow_milestones and record.allow_milestones.raw_value and record.milestone_count.raw_value &gt; 0" t-attf-class="d-inline-block small me-1 text-{{ record.is_milestone_deadline_exceeded.raw_value ? 'danger' : (record.can_mark_milestone_as_done.raw_value ? 'success' : 'muted') }}" role="button" name="action_get_list_view" type="object" t-attf-title="#{record.milestone_count_reached.value} Milestones reached out of #{record.milestone_count.value}">
                                            <span class="fa fa-flag me-1"/>
                                            <field name="milestone_count_reached"/>/<field name="milestone_count"/>
                                        </a>
                                    </div>
                                    <field name="activity_ids" widget="kanban_activity" class="ms-2"/>
                                </div>
                                <div class="d-flex ms-auto align-items-center">
                                    <field name="user_id" widget="many2one_avatar_user" domain="[('share', '=', False)]" class="me-1"/>
                                    <field t-if="record.last_update_status.value &amp;&amp; widget.editable &amp;&amp; !record.is_template.raw_value" name="last_update_status" widget="project_state_selection"/>
                                    <span t-if="record.last_update_status.value &amp;&amp; !widget.editable" t-att-class="'o_status_bubble mx-0 o_color_bubble_' + record.last_update_color.value" t-att-title="record.last_update_status.value"/>
                                </div> -->
                            </footer>
                        </t>
                </templates>
            </kanban>
        </field>
    </record>
    <!-- school.year form view -->
    <record id="school_year_view_form" model="ir.ui.view">
        <field name="name">school.year.view.form</field>
        <field name="model">school.year</field>
        <field name="arch" type="xml">
            <form string="Años escolares">
                <header>
                    <button string="Iniciar Año Escolar" 
                            name="action_start_year" 
                            type="object"
                            confirm="¿Está seguro de iniciar este año escolar? Esta acción marcará el año como activo."
                            invisible="state != 'draft'"
                            class="btn-success"/>
                    <button string="Siguiente Lapso" 
                            name="action_next_lapso" 
                            type="object"
                            confirm="¿Está seguro de avanzar al siguiente lapso?"
                            invisible="state != 'active' or current_lapso == '3'"
                            class="btn-primary"/>
                    <button string="Finalizar Año Escolar" 
                            name="action_finish_year" 
                            type="object"
                            confirm="¿Está seguro de finalizar este año escolar? Esta acción bloqueará todas las inscripciones, evaluaciones y demás registros. No se podrán crear ni eliminar registros relacionados."
                            invisible="state != 'active' or current_lapso != '3'"
                            class="btn-danger"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,active,finished"/>
                </header>
                <sheet>
                    <!-- Header con nombre y estado del año -->
                    <div class="oe_button_box" name="button_box">
                        <button name="%(pma_public_school_ve.school_student_action)d" 
                                type="action"
                                class="oe_stat_button" 
                                icon="fa-users"
                                context="{'search_default_year_id': id}">
                            <field name="total_students_count" string="Estudiantes" widget="statinfo"/>
                        </button>
                        <button name="%(pma_public_school_ve.school_section_action)d" 
                                type="action"
                                class="oe_stat_button" 
                                icon="fa-th-large"
                                context="{'search_default_year_id': id}">
                            <field name="total_sections_count" string="Secciones" widget="statinfo"/>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Finalizado" bg_color="text-bg-success" invisible="state != 'finished'"/>
                    <widget name="web_ribbon" title="En Curso" bg_color="text-bg-primary" invisible="state != 'active'"/>
                    
                    <!-- Enhanced Year Header -->
                    <div class="o_year_header mb-3">
                        <div class="row align-items-center">
                            <!-- Year Name & Info (left) -->
                            <div class="col-md-5">
                                <h1 class="mb-0 display-5 fw-bold text-primary">
                                    <field options="{'line_breaks': False}" 
                                           widget="text" 
                                           class="text-break" 
                                           name="name" 
                                           default_focus="1" 
                                           placeholder="e.g. 2025-2026"
                                           readonly="state == 'finished'"/>
                                </h1>
                                <div class="d-flex align-items-center gap-4 mt-2 flex-wrap">
                                    <div class="d-flex align-items-center gap-2" invisible="state == 'finished'">
                                        <field name="current" widget="boolean_toggle" readonly="state == 'finished'"/>
                                        <small class="text-muted">Año Activo</small>
                                    </div>
                                    <div invisible="state == 'draft' or not start_date_real">
                                        <i class="fa fa-calendar-check-o text-success me-1"/>
                                        <small class="text-muted">Inicio: </small>
                                        <field name="start_date_real" nolabel="1" class="fw-semibold"/>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Lapsos Timeline (center-right) -->
                            <div class="col-md-7" invisible="state == 'draft'">
                                <field name="current_lapso" widget="lapsos_timeline" nolabel="1"/>
                            </div>
                        </div>
                    </div>
                    
                    <field name="is_locked" invisible="1"/>

                    <!-- NOTEBOOK CONVERTIDO EN DASHBOARD -->
                    <notebook>
                        <!-- TAB 1: Dashboard de Rendimiento General -->
                        <page string="Dashboard General" name="dashboard">
                            <group>
                                <group string="Rendimiento General del Año Escolar" colspan="2">
                                    <field name="performance_by_level_json" 
                                        widget="year_performance_overview" 
                                        nolabel="1" colspan="2"/>
                                </group>
                            </group>

                            <!-- New Row: Sections and Professors Distribution -->
                            <group>
                                <group string="Distribución de Secciones por Nivel">
                                    <field name="sections_distribution_json" 
                                           widget="sections_gauge_chart" 
                                           nolabel="1" colspan="2"/>
                                </group>
                                
                                <group string="Distribución de Profesores por Nivel">
                                    <field name="professors_distribution_json" 
                                           widget="professors_radar_chart" 
                                           nolabel="1" colspan="2"/>
                                </group>
                            </group>

                            <group>
                                <group string="Distribución de Estudiantes por Nivel">
                                    <field name="students_distribution_json" 
                                           widget="students_distribution_chart" 
                                           nolabel="1" colspan="2"/>
                                </group>
                                
                                <group string="Tasa de Aprobación General">
                                    <field name="approval_rate_json" 
                                           widget="approval_rate_gauge" 
                                           nolabel="1" colspan="2"/>
                                </group>
                            </group>

                            <group>
                                <group string="Mejor Sección por Nivel" colspan="2">
                                    <field name="sections_comparison_json" 
                                        widget="sections_comparison_chart" 
                                        nolabel="1" colspan="2"/>
                                </group>

                                <group string="Top 9 Mejores Estudiantes (3 por Nivel)" colspan="2">
                                    <field name="top_students_year_json" 
                                        widget="top_students_list" 
                                        nolabel="1" colspan="2"/>
                                </group>
                            </group>
                        </page>

                        <!-- TAB 2: Media General (tu estructura original mejorada) -->
                        <page string="Media General" name="secundary">
                            <separator string="Configuración de Evaluación"/>
                            <group>
                                <field name="evalution_type_secundary" options="{'no_create':True}"/>
                            </group>

                            <!-- KPI Cards + Progress Bar (replaces old counters) -->
                            <separator string="Estadísticas de estudiantes"/>
                            <field name="secundary_general_dashboard_json" 
                                   widget="level_dashboard_kpi" 
                                   nolabel="1"/>

                            <separator string="Grados de Media General"/>
                            <field name="sections_secundary_ids" 
                                   widget="many2many_tags"
                                   readonly="1"/>

                            <group string="Rendimiento de Media General">
                                <field name="secundary_performance_json" 
                                       widget="general_performance_graph"
                                       colspan="2" 
                                       nolabel="1"/>
                            </group>
                            
                            <!-- Top 3 estudiantes por sección -->
                            <group string="Top 3 Estudiantes por Sección">
                                <field name="secundary_general_dashboard_json" 
                                       widget="level_dashboard_students" 
                                       colspan="2"
                                       nolabel="1"/>
                            </group>
                        </page>

                        <!-- TAB 3: Técnico Medio (NUEVO) -->
                        <page string="Técnico Medio" name="secundary_tecnico">
                            <separator string="Configuración de Evaluación"/>
                            <group>
                                <field name="evalution_type_secundary" options="{'no_create':True}" readonly="1"/>
                            </group>

                            <!-- KPI Cards + Progress Bar (replaces old counters) -->
                            <separator string="Estadísticas de estudiantes"/>
                            <field name="secundary_tecnico_dashboard_json" 
                                   widget="level_dashboard_kpi" 
                                   nolabel="1"/>

                            <separator string="Menciones de Técnico Medio"/>
                            <!-- FIX: Cambiado de many2many_tags (usaba display_name con año) a 
                                 mentions_tags_widget que muestra solo nombre de mención sin año y sin truncamiento -->
                            <field name="mentions_names_json" 
                                   widget="mentions_tags_widget"
                                   nolabel="1"/>

                            <group string="Rendimiento de Técnico Medio">
                                <field name="tecnico_performance_json" 
                                       widget="general_performance_graph"
                                       colspan="2" 
                                       nolabel="1"/>
                            </group>
                            
                            <!-- Top 3 estudiantes por Mención -->
                            <group string="Top 3 Estudiantes por Mención">
                                <field name="secundary_tecnico_dashboard_json" 
                                       widget="level_dashboard_students" 
                                       colspan="2"
                                       nolabel="1"/>
                            </group>
                        </page>

                        <!-- TAB 3: Primaria (tu estructura original mejorada) -->
                        <page string="Primaria" name="primary">
                            <separator string="Configuración de Evaluación"/>
                            <group>
                                <field name="evalution_type_primary" options="{'no_create':True}"/>
                            </group>

                            <!-- KPI Cards + Progress Bar (replaces old counters) -->
                            <separator string="Estadísticas de estudiantes"/>
                            <field name="primary_dashboard_json" 
                                   widget="level_dashboard_kpi" 
                                   nolabel="1"/>

                            <separator string="Grados de Primaria"/>
                            <field name="sections_primary_ids_m2m" 
                                   widget="many2many_tags"
                                   readonly="1"/>

                            <group string="Rendimiento de Primaria">
                                <field name="primary_performance_json" 
                                       widget="general_performance_graph" 
                                       colspan="2"
                                       nolabel="1"/>
                            </group>
                            
                            <!-- Top 3 estudiantes por sección -->
                            <group string="Top 3 Estudiantes por Sección">
                                <field name="primary_dashboard_json" 
                                       widget="level_dashboard_students" 
                                       colspan="2"
                                       nolabel="1"/>
                            </group>
                        </page>

                        <!-- TAB 4: Preescolar (tu estructura original mejorada) -->
                        <page string="Preescolar" name="pre">
                            <separator string="Configuración de Evaluación"/>
                            <group>
                                <field name="evalution_type_pree" options="{'no_create':True}"/>
                            </group>

                            <!-- KPI Dashboard (like other tabs) -->
                            <separator string="Estadísticas de Preescolar"/>
                            <field name="pre_dashboard_json" 
                                   widget="level_dashboard" 
                                   nolabel="1" colspan="2"/>

                            <separator string="Grados de Preescolar"/>
                            <field name="sections_pre_ids_m2m" 
                                   widget="many2many_tags"
                                   readonly="1"/>
                            
                            <!-- Observations Timeline -->
                            <separator string="Últimas Observaciones"/>
                            <field name="pre_observations_timeline_json" 
                                   widget="pre_observations_timeline" 
                                   nolabel="1" colspan="2"/>
                        </page>

                        <!-- TAB 5: Todos los Estudiantes -->
                        <page string="Estudiantes" name="all_students">
                            <!-- Distribución por Género y Estado -->
                            <separator string="Distribución de Estudiantes"/>
                            <field name="students_tab_json" 
                                   widget="students_distribution_stats" 
                                   nolabel="1" colspan="2"/>
                            
                            <!-- Rendimiento y Niveles -->
                            <separator string="Rendimiento y Niveles"/>
                            <field name="students_tab_json" 
                                   widget="students_approval_stats" 
                                   nolabel="1" colspan="2"/>
                            
                            <!-- Top 10 Mejores Promedios -->
                            <separator string="Top 10 Mejores Promedios"/>
                            <field name="students_tab_json" 
                                   widget="students_top_performers" 
                                   nolabel="1" colspan="2"/>
                            
                            <!-- Estudiantes en Riesgo -->
                            <separator string="Estudiantes en Riesgo Académico"/>
                            <field name="students_tab_json" 
                                   widget="students_at_risk" 
                                   nolabel="1" colspan="2"/>
                        </page>

                        <!-- TAB 6: Profesores y Materias -->
                        <page string="Profesores" name="professors">
                            <!-- KPI Cards + Progress Bar -->
                            <separator string="Estadísticas de Profesores"/>
                            <field name="professor_dashboard_json" 
                                   widget="professor_dashboard_kpi" 
                                   nolabel="1"/>

                            <!-- Top 5 + Distribution -->
                            <separator string="Top Profesores y Distribución"/>
                            <field name="professor_dashboard_json" 
                                   widget="professor_dashboard_ranking" 
                                   nolabel="1"/>

                            <separator string="Materias con Mayor Dificultad"/>
                            <field name="difficult_subjects_json" 
                                   widget="difficult_subjects_chart" 
                                   nolabel="1"/>
                        </page>

                        <!-- TAB 7: Evaluaciones -->
                        <page string="Evaluaciones" name="evaluations">
                            <group string="Estadísticas de Evaluaciones">
                                <field name="evaluations_stats_json" 
                                       widget="evaluations_stats_widget"
                                       colspan="2"
                                       nolabel="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- school_year action window -->

    <record id="school_year_action" model="ir.actions.act_window">
        <field name="name">Año escolar</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">school.year</field>
        <field name="view_mode">kanban,form</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
    </record>

    <record id="current_school_year_action_tag" model="ir.actions.client">
        <field name="name">Año Escolar Actual</field>
        <field name="tag">current_school_year_action</field>
    </record>
</odoo>
