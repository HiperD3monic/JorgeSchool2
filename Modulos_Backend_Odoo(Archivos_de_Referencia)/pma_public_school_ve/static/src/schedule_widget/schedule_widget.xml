<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="pma_public_school_ve.ScheduleWidget">
        <div class="o_action">
            <Layout display="{ controlPanel: {} }">
                <!-- Control Panel Buttons -->
                <t t-set-slot="control-panel-always-buttons">
                    <button t-on-click="printSchedule" 
                            t-att-disabled="!state.selectedSection or !hasScheduleData()"
                            class="btn btn-secondary" title="Imprimir">
                        <i class="fa fa-print"/> Imprimir
                    </button>
                    <button t-on-click="exportToPDF" 
                            t-att-disabled="!state.selectedSection or !hasScheduleData()"
                            class="btn btn-primary" title="Exportar PDF">
                        <i class="fa fa-file-pdf-o"/> PDF
                    </button>
                </t>

                <!-- Layout Actions (Filters) -->
                <t t-set-slot="layout-actions">
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <div class="input-group" style="width: auto; min-width: 280px;">
                            <span class="input-group-text fw-bold">
                                <i class="fa fa-graduation-cap"/> Secci贸n
                            </span>
                            <select class="form-select" t-on-change="onSectionChange" t-att-disabled="state.loading">
                                <option value="">Seleccionar...</option>
                                <t t-foreach="state.sections" t-as="section" t-key="section.id">
                                    <option t-att-value="section.id" 
                                            t-att-selected="state.selectedSection and state.selectedSection.id === section.id">
                                        <t t-esc="section.section_id[1]"/>
                                    </option>
                                </t>
                            </select>
                        </div>
                    </div>
                </t>

                <!-- Main Content -->
                <div class="o_schedule_widget">
                    <!-- Loading Spinner -->
                    <div t-if="state.loading" class="d-flex justify-content-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>

                    <!-- Empty State: No Section Selected -->
                    <div t-if="!state.loading and !state.selectedSection" class="o_view_nocontent">
                        <div class="o_nocontent_help">
                            <p class="o_view_nocontent_smiling_face">
                                Seleccione una secci贸n
                            </p>
                            <p class="text-muted">
                                Elija una secci贸n para visualizar su horario semanal.
                            </p>
                        </div>
                    </div>

                    <!-- Empty State: No Schedule Data -->
                    <div t-if="!state.loading and state.selectedSection and !hasScheduleData()" class="o_view_nocontent">
                        <div class="o_nocontent_help">
                            <p class="o_view_nocontent_neutral_face">
                                Sin horarios configurados
                            </p>
                            <p class="text-muted">
                                No hay horarios asignados para esta secci贸n.
                            </p>
                        </div>
                    </div>

                    <!-- Calendar Grid View -->
                    <div t-if="!state.loading and state.selectedSection and hasScheduleData()" 
                         class="schedule-calendar-container">
                        
                        <!-- Calendar Grid -->
                        <div class="schedule-calendar-grid">
                            <!-- Header Row: Days -->
                            <div class="schedule-header-row">
                                <!-- Time column header -->
                                <div class="schedule-time-header">
                                    <span class="text-muted small">GMT-04</span>
                                </div>
                                <!-- Day headers -->
                                <t t-foreach="days" t-as="day" t-key="day.key">
                                    <div class="schedule-day-header">
                                        <span class="day-abbrev"><t t-esc="day.label"/></span>
                                    </div>
                                </t>
                            </div>

                            <!-- Time Grid Container with scroll -->
                            <div class="schedule-grid-body" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                                <!-- Time rows -->
                                <t t-foreach="timeSlots" t-as="slot" t-key="slot.hour">
                                    <div class="schedule-time-row">
                                        <!-- Time label -->
                                        <div class="schedule-time-label">
                                            <span><t t-esc="formatHourLabel(slot.hour)"/></span>
                                        </div>
                                        <!-- Day cells -->
                                        <t t-foreach="days" t-as="day" t-key="day.key">
                                            <div class="schedule-cell" t-att-data-day="day.key" t-att-data-hour="slot.hour">
                                                <!-- Schedule blocks that start in this hour -->
                                                <t t-foreach="getSchedulesForCell(day.key, slot.hour)" t-as="schedule" t-key="schedule.id">
                                                    <div class="schedule-block"
                                                         t-att-style="getBlockStyle(schedule)"
                                                         t-att-title="getBlockTooltip(schedule)">
                                                        <div class="block-title">
                                                            <t t-esc="getBlockTitle(schedule)"/>
                                                        </div>
                                                        <div class="block-time" t-if="schedule.duration >= 0.5">
                                                            <t t-esc="formatTime(schedule.start_time)"/> - <t t-esc="formatTime(schedule.end_time)"/>
                                                        </div>
                                                        <div class="block-info" t-if="schedule.duration >= 1 and schedule.professor_name">
                                                            <t t-esc="schedule.professor_name"/>
                                                        </div>
                                                    </div>
                                                </t>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </div>
                        </div>

                        <!-- Legend -->
                        <div class="schedule-legend mt-3 p-3 bg-light rounded" t-if="state.scheduleData">
                            <h6 class="mb-2"><i class="fa fa-info-circle me-1"/> Leyenda</h6>
                            <div class="d-flex flex-wrap gap-3">
                                <t t-set="uniqueItems" t-value="{}"/>
                                <t t-foreach="Object.values(state.scheduleData.schedules)" t-as="daySchedules" t-key="daySchedules_index">
                                    <t t-foreach="daySchedules" t-as="schedule" t-key="schedule.id">
                                        <t t-if="isSubjectBasedSchedule() and schedule.subject_name">
                                            <t t-set="uniqueItems[schedule.subject_name]" t-value="schedule.color"/>
                                        </t>
                                        <t t-if="!isSubjectBasedSchedule() and schedule.professors_names">
                                            <t t-set="uniqueItems[schedule.professors_names]" t-value="schedule.color"/>
                                        </t>
                                    </t>
                                </t>
                                <t t-foreach="Object.keys(uniqueItems)" t-as="itemLabel" t-key="itemLabel">
                                    <div class="d-flex align-items-center">
                                        <span class="legend-color me-2" 
                                              t-att-style="'background-color: ' + getBlockColor(uniqueItems[itemLabel])"/>
                                        <span class="small"><t t-esc="itemLabel"/></span>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </Layout>
        </div>
    </t>

</templates>
