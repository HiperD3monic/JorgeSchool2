<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">
    <t t-name="school.LevelDashboard">
        <div class="o_level_dashboard">
            <t t-if="hasData">
                <!-- KPI Cards Row (only in kpi_only or full mode) -->
                <t t-if="showKpis">
                    <div class="row g-3 kpi-row mb-3">
                        <div class="col-md-3 col-6">
                            <div class="kpi-card">
                                <div class="kpi-icon icon-total"><i class="fa fa-users"/></div>
                                <span class="kpi-value"><t t-esc="state.animatedTotal"/></span>
                                <span class="kpi-label">Total Estudiantes</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="kpi-card">
                                <div class="kpi-icon icon-approved"><i class="fa fa-check-circle"/></div>
                                <span class="kpi-value text-success"><t t-esc="state.animatedApproved"/></span>
                                <span class="kpi-label">Aprobados</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="kpi-card">
                                <div class="kpi-icon icon-failed"><i class="fa fa-times-circle"/></div>
                                <span class="kpi-value text-danger"><t t-esc="state.animatedFailed"/></span>
                                <span class="kpi-label">Reprobados</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="kpi-card">
                                <div class="kpi-icon icon-sections"><i class="fa fa-th-large"/></div>
                                <span class="kpi-value text-primary"><t t-esc="state.animatedSections"/></span>
                                <span class="kpi-label"><t t-esc="sectionsLabel"/></span>
                            </div>
                        </div>
                    </div>

                    <!-- Approval Progress Bar -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">Tasa de Aprobaci√≥n</small>
                            <small t-attf-class="fw-bold {{ approvalRate >= 80 ? 'text-success' : approvalRate >= 60 ? 'text-warning' : 'text-danger' }}">
                                <t t-esc="approvalRate"/>%
                            </small>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div t-attf-class="progress-bar {{ getApprovalRateClass() }}" 
                                 t-att-style="'width: ' + approvalRate + '%'"/>
                        </div>
                    </div>
                </t>

                <!-- Top Students by Section as TABLE (only in students_only or full mode) -->
                <t t-if="showStudents and topStudentsBySection.length > 0">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0" style="width: 100%;">
                                <thead style="background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);">
                                    <tr>
                                        <th class="ps-3 py-2 border-0 text-white small" style="width: 50px;">Pos.</th>
                                        <th class="py-2 border-0 text-white small">Estudiante</th>
                                        <th class="py-2 border-0 text-white small text-end pe-3">Promedio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="topStudentsBySection" t-as="section" t-key="section.section_id">
                                        <!-- Section Header Row -->
                                        <tr style="background: #E8E8E8;">
                                            <td colspan="3" class="ps-3 py-1 border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="fa fa-bookmark text-secondary me-2" style="font-size: 11px;"/>
                                                    <strong class="text-dark small"><t t-esc="section.section_name"/></strong>
                                                </div>
                                            </td>
                                        </tr>
                                        <!-- Students in this section (indented) -->
                                        <t t-foreach="section.top_3" t-as="student" t-key="student.student_id">
                                            <tr t-on-click="() => this.onStudentClick(student.student_id)"
                                                style="cursor: pointer; background: #FAFAFA;"
                                                class="student-row">
                                                <td class="py-1 align-middle text-center" style="padding-left: 24px !important;">
                                                    <span t-if="student_index === 0" class="badge rounded-pill px-1" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); font-size: 10px;">
                                                        <i class="fa fa-trophy"/>
                                                    </span>
                                                    <span t-elif="student_index === 1" class="badge rounded-pill px-1" style="background: #C0C0C0; font-size: 10px;">
                                                        <i class="fa fa-star"/>
                                                    </span>
                                                    <span t-elif="student_index === 2" class="badge rounded-pill px-1" style="background: #CD7F32; color: white; font-size: 10px;">
                                                        <i class="fa fa-star"/>
                                                    </span>
                                                    <span t-else="" class="text-muted small"><t t-esc="student_index + 1"/></span>
                                                </td>
                                                <td class="py-1 align-middle" style="padding-left: 20px !important;">
                                                    <div class="d-flex align-items-center">
                                                        <div class="student-avatar-xs me-2" t-att-style="'background-color: ' + getAvatarColor(student.student_name)">
                                                            <t t-esc="getInitials(student.student_name)"/>
                                                        </div>
                                                        <span class="text-dark small"><t t-esc="student.student_name"/></span>
                                                    </div>
                                                </td>
                                                <td class="py-1 align-middle text-end pe-3">
                                                    <span class="badge bg-success px-2" style="font-size: 11px;">
                                                        <t t-esc="getDisplayValue(student)"/>
                                                    </span>
                                                </td>
                                            </tr>
                                        </t>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </t>
            </t>
            <t t-elif="showKpis">
                <div class="alert alert-info text-center py-4">
                    <i class="fa fa-info-circle fa-2x mb-2"/>
                    <p class="mb-0">No hay datos disponibles para este nivel.</p>
                </div>
            </t>
        </div>
    </t>
</templates>
