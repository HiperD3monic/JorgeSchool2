<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="pma_public_school_ve.AttendanceRegister">
        <div class="attendance-register-container p-3">
            <!-- Header -->
            <div class="attendance-header mb-4">
                <h2 class="mb-3">
                    <i class="fa fa-check-square"/> Registro de Asistencia
                </h2>
                
                <!-- Date Selector -->
                <div class="row mb-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-control" 
                               t-att-value="state.date"
                               t-on-change="onDateChange"/>
                    </div>
                </div>
                
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item">
                        <button class="nav-link" 
                                t-att-class="{'active': state.activeTab === 'student'}"
                                t-on-click="() => this.switchTab('student')">
                            <i class="fa fa-graduation-cap"/> Estudiantes
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link"
                                t-att-class="{'active': state.activeTab === 'employee'}"
                                t-on-click="() => this.switchTab('employee')">
                            <i class="fa fa-users"/> Personal
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link"
                                t-att-class="{'active': state.activeTab === 'visitor'}"
                                t-on-click="() => this.switchTab('visitor')">
                            <i class="fa fa-user-plus"/> Visitantes
                        </button>
                    </li>
                </ul>
            </div>

            <!-- Loading Spinner -->
            <div t-if="state.loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>

            <!-- TAB CONTENT: STUDENTS -->
            <div t-if="!state.loading and state.activeTab === 'student'" class="tab-content-student">
                <!-- Section and Schedule Selection -->
                <div class="row g-3 mb-4">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Sección</label>
                        <select class="form-select" t-on-change="onSectionChange">
                            <option value="">Seleccionar sección...</option>
                            <t t-foreach="state.sections" t-as="section" t-key="section.id">
                                <option t-att-value="section.id"
                                        t-att-selected="state.selectedSection and state.selectedSection.id === section.id">
                                    <t t-esc="section.section_id[1]"/>
                                </option>
                            </t>
                        </select>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Horario</label>
                        <select class="form-select" t-on-change="onScheduleChange"
                                t-att-disabled="!state.selectedSection">
                            <option value="">Seleccionar horario...</option>
                            <t t-foreach="state.schedules" t-as="schedule" t-key="schedule.id">
                                <option t-att-value="schedule.id"
                                        t-att-selected="state.selectedSchedule and state.selectedSchedule.id === schedule.id">
                                    <t t-esc="schedule.display_name"/>
                                </option>
                            </t>
                        </select>
                    </div>
                </div>

                <!-- Search Box -->
                <div class="mb-3" t-if="state.students.length > 0">
                    <input type="text" class="form-control" 
                           placeholder="Buscar estudiante por nombre..."
                           t-model="state.studentSearch"
                           t-on-input="() => this.render()"/>
                </div>

                <!-- Students List -->
                <div t-if="state.students.length > 0">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th style="width: 150px;">Estado</th>
                                    <th style="width: 100px;">Hora Entrada</th>
                                    <th style="width: 100px;">Hora Salida</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="filteredStudents" t-as="student" t-key="student.id">
                                    <tr>
                                        <td>
                                            <strong><t t-esc="student.name"/></strong>
                                        </td>
                                        <td>
                                            <select class="form-select form-select-sm"
                                                    t-att-value="student.state"
                                                    t-on-change="(ev) => this.updateStudentState(student.id, ev.target.value)">
                                                <option value="absent">Ausente</option>
                                                <option value="present">Presente</option>
                                                <option value="late">Tardanza</option>
                                                <option value="permission">Permiso</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="time" class="form-control form-control-sm"
                                                   t-att-value="student.check_in_time"
                                                   t-att-disabled="!isStudentTimeEditable(student)"
                                                   t-on-input="(ev) => student.check_in_time = ev.target.value"/>
                                        </td>
                                        <td>
                                            <input type="time" class="form-control form-control-sm"
                                                   t-att-value="student.check_out_time"
                                                   t-att-disabled="!isStudentTimeEditable(student)"
                                                   t-on-input="(ev) => student.check_out_time = ev.target.value"/>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm"
                                                   t-att-value="student.observations"
                                                   t-on-input="(ev) => student.observations = ev.target.value"
                                                   placeholder="Opcional..."/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-end mt-3">
                        <button class="btn btn-primary" t-on-click="saveStudentAttendances">
                            <i class="fa fa-save"/> Guardar Asistencias
                        </button>
                    </div>
                </div>
                
                <div t-else="" class="alert alert-info text-center">
                    <i class="fa fa-info-circle"/> Seleccione una sección y un horario para cargar los estudiantes
                </div>
            </div>

            <!-- TAB CONTENT: EMPLOYEES -->
            <div t-if="!state.loading and state.activeTab === 'employee'" class="tab-content-employee">
                <!-- Employee Type Filter and Search -->
                <div class="row g-3 mb-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Tipo de Personal</label>
                        <select class="form-select" t-on-change="onEmployeeTypeChange">
                            <option value="">Todos los tipos...</option>
                            <t t-foreach="state.employeeTypes" t-as="empType" t-key="empType.value">
                                <option t-att-value="empType.value"
                                        t-att-selected="state.selectedEmployeeType === empType.value">
                                    <t t-esc="empType.label"/>
                                </option>
                            </t>
                        </select>
                    </div>
                    <div class="col-12 col-md-8">
                        <label class="form-label">Buscar</label>
                        <input type="text" class="form-control" 
                               placeholder="Buscar personal por nombre..."
                               t-model="state.employeeSearch"
                               t-on-input="() => this.render()"/>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Personal del Día</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th style="width: 140px;">Estado</th>
                                        <th style="width: 100px;">Hora Entrada</th>
                                        <th style="width: 100px;">Hora Salida</th>
                                        <th style="width: 120px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="filteredEmployees" t-as="employee" t-key="employee.id">
                                        <tr>
                                            <td>
                                                <strong><t t-esc="employee.name"/></strong>
                                                <t t-if="employee.school_employee_type">
                                                    <br/><small class="text-muted">
                                                        <t t-if="employee.school_employee_type === 'administrativo'">Administrativo</t>
                                                        <t t-if="employee.school_employee_type === 'docente'">Docente</t>
                                                        <t t-if="employee.school_employee_type === 'obrero'">Obrero</t>
                                                        <t t-if="employee.school_employee_type === 'cenar'">Cenar</t>
                                                    </small>
                                                </t>
                                            </td>
                                            <td>
                                                <select class="form-select form-select-sm"
                                                        t-att-value="employee.state"
                                                        t-on-change="(ev) => this.updateEmployeeState(employee.id, ev.target.value)">
                                                    <option value="absent">Ausente</option>
                                                    <option value="present">Presente</option>
                                                    <option value="late">Tardanza</option>
                                                    <option value="permission">Permiso</option>
                                                </select>
                                            </td>
                                            <td>
                                                <input type="time" class="form-control form-control-sm"
                                                       t-att-value="employee.check_in_time"
                                                       t-att-disabled="!isEmployeeTimeEditable(employee)"
                                                       t-on-input="(ev) => employee.check_in_time = ev.target.value"/>
                                            </td>
                                            <td>
                                                <input type="time" class="form-control form-control-sm"
                                                       t-att-value="employee.check_out_time"
                                                       t-att-disabled="!isEmployeeTimeEditable(employee)"
                                                       t-on-input="(ev) => employee.check_out_time = ev.target.value"/>
                                            </td>
                                            <td>
                                                <button t-if="canShowCheckOutButton(employee)"
                                                        class="btn btn-sm btn-success"
                                                        t-on-click="() => this.markEmployeeCheckOut(employee.id)">
                                                    <i class="fa fa-sign-out"/> Marcar Salida
                                                </button>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="text-end mt-3">
                            <button class="btn btn-primary" t-on-click="saveEmployeeAttendances">
                                <i class="fa fa-save"/> Guardar Asistencias
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB CONTENT: VISITORS -->
            <div t-if="!state.loading and state.activeTab === 'visitor'" class="tab-content-visitor">
                <div class="row">
                    <!-- Registration Form -->
                    <div class="col-12 col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Registrar Nuevo Visitante</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Nombre Completo *</label>
                                    <input type="text" class="form-control"
                                           t-att-value="state.visitorName"
                                           t-on-input="(ev) => state.visitorName = ev.target.value"
                                           placeholder="Ej: Juan Pérez"/>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Cédula *</label>
                                    <input type="text" class="form-control"
                                           t-att-value="state.visitorIdNumber"
                                           t-on-input="(ev) => state.visitorIdNumber = ev.target.value"
                                           placeholder="Ej: V-12345678"/>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Destino</label>
                                    <input type="text" class="form-control"
                                           t-att-value="state.visitorDestination"
                                           t-on-input="(ev) => state.visitorDestination = ev.target.value"
                                           placeholder="Ej: Dirección, Aula 101..."/>
                                </div>
                                
                                <button class="btn btn-primary w-100" t-on-click="registerVisitor">
                                    <i class="fa fa-user-plus"/> Registrar Visitante
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Today's Visitors List -->
                    <div class="col-12 col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Visitantes de Hoy</h5>
                            </div>
                            <div class="card-body">
                                <t t-if="state.todayVisitors.length === 0">
                                    <div class="alert alert-light text-center">
                                        <i class="fa fa-info-circle"/> No hay visitantes registrados para hoy
                                    </div>
                                </t>
                                <t t-else="">
                                    <div class="list-group">
                                        <t t-foreach="state.todayVisitors" t-as="visitor" t-key="visitor.id">
                                            <div class="list-group-item">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <h6 class="mb-1"><t t-esc="visitor.visitor_name"/></h6>
                                                    <small><t t-esc="floatToTime(visitor.check_in_time)"/></small>
                                                </div>
                                                <p class="mb-1"><small><strong>Cédula:</strong> <t t-esc="visitor.visitor_id_number"/></small></p>
                                                <p class="mb-0" t-if="visitor.visitor_destination">
                                                    <small><strong>Destino:</strong> <t t-esc="visitor.visitor_destination"/></small>
                                                </p>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>

</templates>
